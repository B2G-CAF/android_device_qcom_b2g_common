
if [[ -z "${TARGET_PRODUCT}" ]]; then
   echo "Error: TARGET_PRODUCT not defined.  Looks like you need some |lunch|"
   exit 1
fi

cd ${ANDROID_BUILD_TOP}
B2G_HOME=$PWD

TOOLCHAIN_PREFIX=${ANDROID_TOOLCHAIN}/$(test -x ${ANDROID_TOOLCHAIN}/arm-eabi-gcc && echo arm-eabi- || echo arm-linux-androideabi-)
GDB=${TOOLCHAIN_PREFIX}gdb

DEVICE=${TARGET_PRODUCT}
GECKO_PATH=${ANDROID_BUILD_TOP}/gecko
GAIA_PATH=${ANDROID_BUILD_TOP}/gaia

# TODO: GECKO_OBJDIR must match that in gonk-misc/Android.mk.  Fragile.
GECKO_OBJDIR=${ANDROID_BUILD_TOP}/out/target/product/${DEVICE}/obj/objdir-gecko


# Default GAIA_DOMAIN away from gaiamobile.org to prevent the UI from
# automatically updating itself to an unknown version
#
# TODO: This GAIA_DOMAIN logic is duplicated in Android.mk.  Fragile.
: ${GAIA_DOMAIN:=example.com}
# 'export' need to propagate the variable into |flash gaia|
export GAIA_DOMAIN


__flash_device()
{
	if [ "$1" = "ext" ]; then
		run_adb remount
		run_adb shell rm -r /system/b2g/distribution/extensions
		run_adb push out/target/product/$DEVICE/system/b2g/distribution/extensions /system/b2g/distribution/extensions
		run_adb shell rm -r /data/b2g
		return
	fi

	$ADB reboot bootloader
	$FASTBOOT devices

	if [ $? -ne 0 ]; then
		echo Couldn\'t setup fastboot
		return -1
	fi
	if [ -z $1 ]; then
		$FASTBOOT erase cache &&
		$FASTBOOT erase userdata &&
		$FASTBOOT flash userdata out/target/product/$DEVICE/userdata.img.ext4 &&
		$FASTBOOT flash boot out/target/product/$DEVICE/boot.img &&
		$FASTBOOT flash system out/target/product/$DEVICE/system.img.ext4 &&
		$FASTBOOT flash persist out/target/product/$DEVICE/persist.img.ext4 &&
		$FASTBOOT reboot
	else
		case $1 in
		"system" | "boot" | "userdata" | "persist")
			$FASTBOOT flash $1 out/target/product/$DEVICE/$1.img.ext4 &&
			$FASTBOOT reboot
			;;
		*)
			echo Error: Unrecognized flash command: $1
		esac
	fi
}

eval "flash_${DEVICE}() { __flash_device $1; }"
