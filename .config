
if [[ -z "${TARGET_PRODUCT}" ]]; then
   echo "Error: TARGET_PRODUCT not defined.  Looks like you need some |lunch|"
   exit 1
fi

cd ${ANDROID_BUILD_TOP}
B2G_HOME=$PWD

TOOLCHAIN_PREFIX=${ANDROID_TOOLCHAIN}/$(test -x ${ANDROID_TOOLCHAIN}/arm-eabi-gcc && echo arm-eabi- || echo arm-linux-androideabi-)
GDB=${TOOLCHAIN_PREFIX}gdb

DEVICE=${TARGET_PRODUCT}
GECKO_PATH=${ANDROID_BUILD_TOP}/gecko
GAIA_PATH=${ANDROID_BUILD_TOP}/gaia

# TODO: GECKO_OBJDIR must match that in gonk-misc/Android.mk.  Fragile.
GECKO_OBJDIR=${ANDROID_BUILD_TOP}/out/target/product/${DEVICE}/obj/objdir-gecko


flash_fastboot_ext4()
{
	$ADB reboot bootloader
	$FASTBOOT devices

	if [ $? -ne 0 ]; then
		echo Couldn\'t setup fastboot
		return -1
	fi
	case $1 in
	"system" | "boot" | "userdata" | "persist")
		$FASTBOOT flash $1 out/target/product/$DEVICE/$1.img.ext4 &&
		$FASTBOOT reboot
		;;

	*)
		$FASTBOOT erase cache &&
		$FASTBOOT erase userdata &&
		$FASTBOOT flash userdata out/target/product/$DEVICE/userdata.img.ext4 &&
		$FASTBOOT flash boot out/target/product/$DEVICE/boot.img &&
		$FASTBOOT flash system out/target/product/$DEVICE/system.img.ext4 &&
		$FASTBOOT flash persist out/target/product/$DEVICE/persist.img.ext4 &&
		$FASTBOOT reboot
		;;
	esac
}

eval "flash_${DEVICE}() { flash_fastboot_ext4 $1; }"
