From f7f62a480ba73a3a620558e192fcdf6f9956b40f Mon Sep 17 00:00:00 2001
From: Suresh Vankadara <svankada@codeaurora.org>
Date: Tue, 11 Dec 2012 16:23:47 +0530
Subject: [PATCH] msm: camera: fix kernel crash due to NULL mctl_cmd.

Change-Id: Ib0e9d7cb2898fff48c1a2cc799014b7e47391b47
Signed-off-by: Suresh Vankadara <svankada@codeaurora.org>
---
 drivers/media/video/msm/msm.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/drivers/media/video/msm/msm.c b/drivers/media/video/msm/msm.c
index 86f0cbd..38fbad3 100755
--- a/drivers/media/video/msm/msm.c
+++ b/drivers/media/video/msm/msm.c
@@ -261,6 +261,7 @@ static void msm_cam_stop_hardware(struct msm_cam_v4l2_device *pcam)
 		if (rc < 0)
 			pr_err("mctl_release fails %d\n", rc);
 		pmctl->mctl_release = NULL;
+		pmctl->mctl_cmd = NULL;
 	}
 }
 
@@ -1964,9 +1965,12 @@ msm_send_open_server_failed:
 	v4l2_fh_del(&pcam_inst->eventHandle);
 	v4l2_fh_exit(&pcam_inst->eventHandle);
 mctl_event_q_setup_failed:
-	if (pmctl->mctl_release)
+	if (pmctl->mctl_release) {
 		if (pmctl->mctl_release(pmctl) < 0)
 			pr_err("%s: mctl_release failed\n", __func__);
+		pmctl->mctl_cmd = NULL;
+		pmctl->mctl_release = NULL;
+	}
 mctl_open_failed:
 	if (pcam->use_count == 1) {
 #ifdef CONFIG_MSM_MULTIMEDIA_USE_ION
@@ -2015,6 +2019,7 @@ int msm_cam_server_close_mctl_session(struct msm_cam_v4l2_device *pcam)
 		rc = pmctl->mctl_release(pmctl);
 		if (rc < 0)
 			pr_err("mctl_release fails %d\n", rc);
+		pmctl->mctl_cmd = NULL;
 	}
 
 #ifdef CONFIG_MSM_MULTIMEDIA_USE_ION
@@ -2199,6 +2204,7 @@ static int msm_close(struct file *f)
 			rc = pmctl->mctl_release(pmctl);
 			if (rc < 0)
 				pr_err("mctl_release fails %d\n", rc);
+			pmctl->mctl_cmd = NULL;
 		}
 
 #ifdef CONFIG_MSM_MULTIMEDIA_USE_ION
-- 
1.7.8.3

